<html class="js flexbox fontface" lang="en" style=""><head><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Real World OCaml</title><link rel="stylesheet" href="css/app.css"/><script src="js/min/modernizr-min.js"></script><script src="//use.typekit.net/gfj8wez.js"></script><script>try{Typekit.load();}catch(e){}</script></head></head><body><div class="title-bar"><div class="title"><h1>Real World OCaml</h1><h5>2<sup>nd</sup> Edition (in progress)</h5><nav><a href="index.html">Home</a><a href="toc.html">Table of Contents</a><a href="faqs.html">FAQs</a><a href="install.html">Install</a><a href="https://ocaml.janestreet.com/ocaml-core/">API Docs</a></nav></div></div><div class="wrap"><div class="left-column"><a href="toc.html" class="to-chapter"><small>Back</small><h5>Table of Contents</h5></a></div><article class="main-body">
  <section xmlns="http://www.w3.org/1999/xhtml" id="first-class-modules" data-type="chapter">
    <h1>First-Class Modules</h1>

    <p>
      You can think of OCaml as being broken up into two parts: a core
      language that is concerned with values and types, and a module
      language that is concerned with modules and module
      signatures. These sublanguages are stratified, in that modules
      can contain types and values, but ordinary values can't contain
      modules or module types. That means you can't do things like
      define a variable whose value is a module, or a function that
      takes a module as an argument.

      <a data-type="indexterm" data-primary="modules" data-secondary="first-class modules" id="MODfirst">&nbsp;</a></p>

    <p>
      OCaml provides a way around this stratification in the form
      of <em>first-class modules</em>. First-class modules are
      ordinary values that can be created from and converted back to
      regular modules.

      <a data-type="indexterm" data-primary="first-class modules" data-secondary="working with" id="FCMwork">&nbsp;</a></p>

    <p>
      First-class modules are a sophisticated technique, and you'll
      need to get comfortable with some advanced aspects of the
      language to use them effectively. But it's worth learning,
      because letting modules into the core language is quite
      powerful, increasing the range of what you can express and
      making it easier to build flexible and
      modular <span class="keep-together">systems</span>.</p>

    <section id="working-with-first-class-modules" data-type="sect1">
      <h1>Working with First-Class Modules</h1>

      <p>
	We'll start out by covering the basic mechanics of
	first-class modules by working through some toy examples.
	We'll get to more realistic examples in the next section.</p>

      <p>
	In that light, consider the following signature of a module
	with a single integer variable:</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">open</span> <span class="nc">Core_kernel</span><span class="o">;;</span>
</pre><pre><span></span><span class="o">#</span> <span class="k">module</span> <span class="k">type</span> <span class="nc">X_int</span> <span class="o">=</span> <span class="k">sig</span> <span class="k">val</span> <span class="n">x</span> <span class="o">:</span> <span class="o">int</span> <span class="k">end</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">module</span> <span class="k">type</span> <span class="nc">X_int</span> <span class="o">=</span> <span class="k">sig</span> <span class="k">val</span> <span class="n">x</span> <span class="o">:</span> <span class="o">int</span> <span class="k">end</span>
</pre></div>

      <p>We can also create a module that matches this signature:</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">module</span> <span class="nc">Three</span> <span class="o">:</span> <span class="nc">X_int</span> <span class="o">=</span> <span class="k">struct</span> <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="o">3</span> <span class="k">end</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">module</span> <span class="nc">Three</span> <span class="o">:</span> <span class="nc">X_int</span>
</pre><pre><span></span><span class="o">#</span> <span class="nn">Three</span><span class="p">.</span><span class="n">x</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="o">-</span> <span class="o">:</span> <span class="o">int</span> <span class="o">=</span> <span class="o">3</span>
</pre></div>

      <p>
	A first-class module is created by packaging up a module with
	a signature that it satisfies. This is done using
	the <code>module</code> keyword.

	<a data-type="indexterm" data-primary="module keyword">&nbsp;</a></p>

      <div class="highlight"><pre>(module &lt;Module&gt; : &lt;Module_type&gt;)
</pre></div>

      <p>We can convert <code>Three</code> into a first-class module
      as follows:</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">three</span> <span class="o">=</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Three</span> <span class="o">:</span> <span class="nc">X_int</span><span class="o">);;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">three</span> <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">X_int</span><span class="o">)</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">module</span><span class="o">&gt;</span>
</pre></div>

      <p>The module type doesn't need to be part of the
      construction of a first-class module if it can be inferred.
      Thus, we can write:</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">module</span> <span class="nc">Four</span> <span class="o">=</span> <span class="k">struct</span> <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="o">4</span> <span class="k">end</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">module</span> <span class="nc">Four</span> <span class="o">:</span> <span class="k">sig</span> <span class="k">val</span> <span class="n">x</span> <span class="o">:</span> <span class="o">int</span> <span class="k">end</span>
</pre><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">numbers</span> <span class="o">=</span> <span class="o">[</span> <span class="o">three;</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Four</span><span class="o">)</span> <span class="o">];;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">numbers</span> <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">X_int</span><span class="o">)</span> <span class="o">list</span> <span class="o">=</span> <span class="o">[&lt;</span><span class="k">module</span><span class="o">&gt;;</span> <span class="o">&lt;</span><span class="k">module</span><span class="o">&gt;]</span>
</pre></div>

      <p>We can also create a first-class module from an anonymous
      module:</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">numbers</span> <span class="o">=</span> <span class="o">[three;</span> <span class="o">(</span><span class="k">module</span> <span class="k">struct</span> <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="o">4</span> <span class="k">end</span><span class="o">)];;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">numbers</span> <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">X_int</span><span class="o">)</span> <span class="o">list</span> <span class="o">=</span> <span class="o">[&lt;</span><span class="k">module</span><span class="o">&gt;;</span> <span class="o">&lt;</span><span class="k">module</span><span class="o">&gt;]</span>
</pre></div>

      <p>In order to access the contents of a first-class module,
      you need to unpack it into an ordinary module. This can be
      done using the <code>val</code> keyword, using this
      syntax:</p>
      <div class="highlight"><pre>(val &lt;first_class_module&gt; : &lt;Module_type&gt;)
</pre></div>

      <p>Here's an example:</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">module</span> <span class="nc">New_three</span> <span class="o">=</span> <span class="o">(</span><span class="k">val</span> <span class="o">three</span> <span class="o">:</span> <span class="nc">X_int</span><span class="o">)</span> <span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">module</span> <span class="nc">New_three</span> <span class="o">:</span> <span class="nc">X_int</span>
</pre><pre><span></span><span class="o">#</span> <span class="nn">New_three</span><span class="p">.</span><span class="n">x</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="o">-</span> <span class="o">:</span> <span class="o">int</span> <span class="o">=</span> <span class="o">3</span>
</pre></div>

      <p>
	We can also write ordinary functions which consume and create
	first-class modules. The following shows the definition of two
	functions: <code>to_int</code>, which converts a <code>(module
	X_int)</code> into an <code>int</code>; and <code>plus</code>,
	which returns the sum of two <code>(module X_int)</code>:</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">to_int</span> <span class="o">m</span> <span class="o">=</span>
    <span class="k">let</span> <span class="k">module</span> <span class="nc">M</span> <span class="o">=</span> <span class="o">(</span><span class="k">val</span> <span class="o">m</span> <span class="o">:</span> <span class="nc">X_int</span><span class="o">)</span> <span class="k">in</span>
    <span class="nn">M</span><span class="p">.</span><span class="n">x</span>
  <span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">to_int</span> <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">X_int</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">int</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">plus</span> <span class="o">m</span><span class="mi">1</span> <span class="o">m2</span> <span class="o">=</span>
    <span class="o">(</span><span class="k">module</span> <span class="k">struct</span>
      <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="o">to_int</span> <span class="o">m</span><span class="mi">1</span> <span class="o">+</span> <span class="o">to_int</span> <span class="o">m2</span>
    <span class="k">end</span> <span class="o">:</span> <span class="nc">X_int</span><span class="o">)</span>
  <span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">plus</span> <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">X_int</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">module</span> <span class="nc">X_int</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">module</span> <span class="nc">X_int</span><span class="o">)</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div>

      <p>With these functions in hand, we can now work with values of
      type <code>(module X_int)</code> in a more natural style, taking
      advantage of the concision and simplicity of the
      core <span class="keep-together">language</span>:</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">si</span><span class="n">x</span> <span class="o">=</span> <span class="o">plus</span> <span class="o">three</span> <span class="o">three;;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">si</span><span class="n">x</span> <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">X_int</span><span class="o">)</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">module</span><span class="o">&gt;</span>
</pre><pre><span></span><span class="o">#</span> <span class="o">to_int</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">fold</span> <span class="o">~init:si</span><span class="n">x</span> <span class="o">~f:plus</span> <span class="o">[three;three]);;</span>
</pre><pre class="ge"><span></span><span class="o">-</span> <span class="o">:</span> <span class="o">int</span> <span class="o">=</span> <span class="mi">12</span>
</pre></div>

      <p>
	There are some useful syntactic shortcuts when dealing
	with first-class modules. One notable one is that you can do
	the conversion to an ordinary module within a pattern match.
	Thus, we can rewrite the <code>to_int</code> function as
	follows:</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">to_int</span> <span class="o">(</span><span class="k">module</span> <span class="nc">M</span> <span class="o">:</span> <span class="nc">X_int</span><span class="o">)</span> <span class="o">=</span> <span class="nn">M</span><span class="p">.</span><span class="n">x</span> <span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">to_int</span> <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">X_int</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">int</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div>

      <p>First-class modules can contain types and functions in
      addition to simple values like <code>int</code>. Here's an
      interface that contains a type and a corresponding
      <code>bump</code> operation that takes a value of the type
      and produces a new one:</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">module</span> <span class="k">type</span> <span class="nc">Bumpable</span> <span class="o">=</span> <span class="k">sig</span>
    <span class="k">type</span> <span class="o">t</span>
    <span class="k">val</span> <span class="o">bump</span> <span class="o">:</span> <span class="o">t</span> <span class="o">-&gt;</span> <span class="o">t</span>
  <span class="k">end</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">module</span> <span class="k">type</span> <span class="nc">Bumpable</span> <span class="o">=</span> <span class="k">sig</span> <span class="k">type</span> <span class="o">t</span> <span class="k">val</span> <span class="o">bump</span> <span class="o">:</span> <span class="o">t</span> <span class="o">-&gt;</span> <span class="o">t</span> <span class="k">end</span>
</pre></div>

      <p>We can create multiple instances of this module with
      different underlying types:</p>
      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">module</span> <span class="nc">Int_bumper</span> <span class="o">=</span> <span class="k">struct</span>
    <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="o">int</span>
    <span class="k">let</span> <span class="o">bump</span> <span class="o">n</span> <span class="o">=</span> <span class="o">n</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">end</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">module</span> <span class="nc">Int_bumper</span> <span class="o">:</span> <span class="k">sig</span> <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="o">int</span> <span class="k">val</span> <span class="o">bump</span> <span class="o">:</span> <span class="o">t</span> <span class="o">-&gt;</span> <span class="o">t</span> <span class="k">end</span>
</pre><pre><span></span><span class="o">#</span> <span class="k">module</span> <span class="nc">Float_bumper</span> <span class="o">=</span> <span class="k">struct</span>
    <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="o">float</span>
    <span class="k">let</span> <span class="o">bump</span> <span class="o">n</span> <span class="o">=</span> <span class="o">n</span> <span class="o">+.</span> <span class="mi">1</span><span class="o">.</span>
  <span class="k">end</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">module</span> <span class="nc">Float_bumper</span> <span class="o">:</span> <span class="k">sig</span> <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="o">float</span> <span class="k">val</span> <span class="o">bump</span> <span class="o">:</span> <span class="o">t</span> <span class="o">-&gt;</span> <span class="o">t</span> <span class="k">end</span>
</pre></div>

      <p>And we can convert these to first-class modules:</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">int_bumper</span> <span class="o">=</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Int_bumper</span> <span class="o">:</span> <span class="nc">Bumpable</span><span class="o">);;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">int_bumper</span> <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Bumpable</span><span class="o">)</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">module</span><span class="o">&gt;</span>
</pre></div>

      <p>But you can't do much with <code>int_bumper</code>, since
      <code>int_bumper</code> is fully abstract, so that we can no
      longer recover the fact that the type in question is
      <code>int</code>.</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Bumpable</span><span class="o">)</span> <span class="o">=</span> <span class="o">int_bumper</span> <span class="k">in</span> <span class="nn">Bumpable</span><span class="p">.</span><span class="n">bump</span> <span class="o">3;;</span>
</pre><pre class="ge">Characters 52-53:
Error: This expression has type int but an expression was expected of type
         Bumpable.t</pre></div>

      <p>To make <code>int_bumper</code> usable, we need to expose
      the type, which we can do as follows:</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">int_bumper</span> <span class="o">=</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Int_bumper</span> <span class="o">:</span> <span class="nc">Bumpable</span> <span class="k">with</span> <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="o">int);;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">int_bumper</span> <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Bumpable</span> <span class="k">with</span> <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="o">int)</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">module</span><span class="o">&gt;</span>
</pre><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">float_bumper</span> <span class="o">=</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Float_bumper</span> <span class="o">:</span> <span class="nc">Bumpable</span> <span class="k">with</span> <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="o">float);;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">float_bumper</span> <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Bumpable</span> <span class="k">with</span> <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="o">float)</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">module</span><span class="o">&gt;</span>
</pre></div>

      <p>
	The sharing constraints we've added above make the resulting
	first-class
	modules <span class="keep-together">polymorphic</span> in the
	type <code>t</code>. As a result, we can now use these
	first-class modules on values of the matching type:</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Bumpable</span><span class="o">)</span> <span class="o">=</span> <span class="o">int_bumper</span> <span class="k">in</span> <span class="nn">Bumpable</span><span class="p">.</span><span class="n">bump</span> <span class="o">3;;</span>
</pre><pre class="ge"><span></span><span class="o">-</span> <span class="o">:</span> <span class="o">int</span> <span class="o">=</span> <span class="o">4</span>
</pre><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Bumpable</span><span class="o">)</span> <span class="o">=</span> <span class="o">float_bumper</span> <span class="k">in</span> <span class="nn">Bumpable</span><span class="p">.</span><span class="n">bump</span> <span class="o">3.5;;</span>
</pre><pre class="ge"><span></span><span class="o">-</span> <span class="o">:</span> <span class="o">float</span> <span class="o">=</span> <span class="o">4.5</span>
</pre></div>

      <p>
	We can also write functions that use such first-class
	modules polymorphically. The following function takes two
	arguments: a <code>Bumpable</code> module and a list of
	elements of the same type as the type <code>t</code> of the
	module:

	<a data-type="indexterm" data-primary="polymorphism" data-secondary="in first-class modules">&nbsp;</a>
	<a data-type="indexterm" data-primary="first-class modules" data-secondary="polymorphism in">&nbsp;</a></p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">bump_list</span>
        <span class="o">(</span><span class="k">type</span> <span class="o">a)</span>
        <span class="o">(</span><span class="k">module</span> <span class="nc">B</span> <span class="o">:</span> <span class="nc">Bumpable</span> <span class="k">with</span> <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="o">a)</span>
        <span class="o">(l:</span> <span class="o">a</span> <span class="o">list)</span>
    <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">~f:</span><span class="nn">B</span><span class="p">.</span><span class="n">bump</span> <span class="o">l</span>
  <span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">bump_list</span> <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Bumpable</span> <span class="k">with</span> <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="k">&#39;</span><span class="o">a)</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="o">a</span> <span class="o">list</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="o">a</span> <span class="o">list</span> <span class="o">=</span>
  <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div>

      <p>
	Here, we used a feature of OCaml that hasn't come up
	before: a <em>locally abstract type</em>. For any function,
	you can declare a pseudoparameter of the form <code>(type
	  a)</code> which introduces a
	fresh type named <code>a</code>. This type acts like an
	abstract type within the context of the function. In the
	example above, the locally abstract type was used as part of a
	sharing constraint that ties the type <code>B.t</code> with
	the type of the elements of the list passed in.

	<a data-type="indexterm" data-primary="datatypes" data-secondary="locally abstract types">&nbsp;</a>
	<a data-type="indexterm" data-primary="abstract types">&nbsp;</a>
	<a data-type="indexterm" data-primary="locally abstract types">&nbsp;</a>
	<a data-type="indexterm" data-primary="sharing constraint">&nbsp;</a>
      </p>

      <p>
	The resulting function is polymorphic in both the type of the
	list element and the type <code>Bumpable.t</code>. We can see
	this function in action:</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="o">bump_list</span> <span class="o">int_bumper</span> <span class="o">[</span><span class="mi">1</span><span class="o">;2;3];;</span>
</pre><pre class="ge"><span></span><span class="o">-</span> <span class="o">:</span> <span class="o">int</span> <span class="o">list</span> <span class="o">=</span> <span class="o">[2;</span> <span class="o">3;</span> <span class="o">4]</span>
</pre><pre><span></span><span class="o">#</span> <span class="o">bump_list</span> <span class="o">float_bumper</span> <span class="o">[</span><span class="mi">1</span><span class="o">.5;2.5;3.5];;</span>
</pre><pre class="ge"><span></span><span class="o">-</span> <span class="o">:</span> <span class="o">float</span> <span class="o">list</span> <span class="o">=</span> <span class="o">[2.5;</span> <span class="o">3.5;</span> <span class="o">4.5]</span>
</pre></div>

      <p>
	Polymorphic first-class modules are important because they
	allow you to connect the types associated with a first-class
	module to the types of other values you're working with.</p>

      <div data-type="note">
        <h1>More on Locally Abstract Types</h1>

        <p>
	  One of the key properties of locally abstract types is
          that they're dealt with as abstract types in the function
          they're defined within, but are polymorphic from the
          outside. Consider the following example:

	  <a data-type="indexterm" data-primary="polymorphism" data-secondary="in locally abstract types">&nbsp;</a></p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="n">wrap_in_list</span> <span class="o">(</span><span class="k">type</span> <span class="o">a)</span> <span class="o">(</span><span class="n">x</span><span class="o">:a)</span> <span class="o">=</span> <span class="o">[</span><span class="n">x</span><span class="o">];;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="n">wrap_in_list</span> <span class="o">:</span> <span class="k">&#39;</span><span class="o">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="o">a</span> <span class="o">list</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div>

      <p>
	This compiles successfully because the type <code>a</code> is
	used in a way that is compatible with it being abstract, but the
	type of the function that is inferred is polymorphic.</p>

	<p>
	  If, on the other hand, we try to use the type <code>a</code>
	  as equivalent to some concrete type, say, <code>int</code>, then
	  the compiler will complain:</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">double_int</span> <span class="o">(</span><span class="k">type</span> <span class="o">a)</span> <span class="o">(</span><span class="n">x</span><span class="o">:a)</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">x</span><span class="o">;;</span>
</pre><pre class="ge">Characters 32-33:
Error: This expression has type a but an expression was expected of type int</pre></div>

      <p>One common use of locally abstract types is to create a
      new type that can be used in constructing a module. Here's an
      example of doing this to create a new first-class module:</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">module</span> <span class="k">type</span> <span class="nc">Comparable</span> <span class="o">=</span> <span class="k">sig</span>
    <span class="k">type</span> <span class="o">t</span>
    <span class="k">val</span> <span class="o">compare</span> <span class="o">:</span> <span class="o">t</span> <span class="o">-&gt;</span> <span class="o">t</span> <span class="o">-&gt;</span> <span class="o">int</span>
  <span class="k">end</span> <span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">module</span> <span class="k">type</span> <span class="nc">Comparable</span> <span class="o">=</span> <span class="k">sig</span> <span class="k">type</span> <span class="o">t</span> <span class="k">val</span> <span class="o">compare</span> <span class="o">:</span> <span class="o">t</span> <span class="o">-&gt;</span> <span class="o">t</span> <span class="o">-&gt;</span> <span class="o">int</span> <span class="k">end</span>
</pre><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">create_comparable</span> <span class="o">(</span><span class="k">type</span> <span class="o">a)</span> <span class="o">compare</span> <span class="o">=</span>
    <span class="o">(</span><span class="k">module</span> <span class="k">struct</span>
      <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="o">a</span>
      <span class="k">let</span> <span class="o">compare</span> <span class="o">=</span> <span class="o">compare</span>
    <span class="k">end</span> <span class="o">:</span> <span class="nc">Comparable</span> <span class="k">with</span> <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="o">a)</span>
  <span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">create_comparable</span> <span class="o">:</span>
  <span class="o">(</span><span class="k">&#39;</span><span class="o">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="o">a</span> <span class="o">-&gt;</span> <span class="o">int)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Comparable</span> <span class="k">with</span> <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="k">&#39;</span><span class="o">a)</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre><pre><span></span><span class="o">#</span> <span class="o">create_comparable</span> <span class="nn">Int</span><span class="p">.</span><span class="n">compare</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="o">-</span> <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Comparable</span> <span class="k">with</span> <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="o">int)</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">module</span><span class="o">&gt;</span>
</pre><pre><span></span><span class="o">#</span> <span class="o">create_comparable</span> <span class="nn">Float</span><span class="p">.</span><span class="n">compare</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="o">-</span> <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Comparable</span> <span class="k">with</span> <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="o">float)</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">module</span><span class="o">&gt;</span>
</pre></div>

	<p>
	  Here, what we effectively do is capture a polymorphic type
	  and export it as a concrete type within a module.</p>

	<p>
	  This technique is useful beyond first-class modules. For
	  example, we can use the same approach to construct a local
	  module to be fed to a functor.

	<a data-type="indexterm" data-startref="FCMwork">&nbsp;</a></p>
      </div>
    </section>

    <section id="example-a-query-handling-framework" data-type="sect1">
      <h1>Example: A Query-Handling Framework</h1>

      <p>
	Now let's look at first-class modules in the context of a
	more complete and realistic example. In particular, consider
	the following signature for a module that implements a system
	for responding to user-generated queries.

	<a data-type="indexterm" data-primary="query-handlers" data-secondary="and first-class modules">&nbsp;</a>
	<a data-type="indexterm" data-primary="first-class modules" data-secondary="query-handling framework" id="FCMquery">&nbsp;</a></p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">module</span> <span class="k">type</span> <span class="nc">Query_handler</span> <span class="o">=</span> <span class="k">sig</span>
  
    <span class="c">(** Configuration for a query handler.  Note that this can be</span>
<span class="c">        converted to and from an s-expression *)</span>
    <span class="k">type</span> <span class="o">config</span> <span class="o">[@@deri</span><span class="n">ving</span> <span class="o">se</span><span class="n">xp</span><span class="o">]</span>
  
    <span class="c">(** The name of the query-handling service *)</span>
    <span class="k">val</span> <span class="o">name</span> <span class="o">:</span> <span class="o">string</span>
  
    <span class="c">(** The state of the query handler *)</span>
    <span class="k">type</span> <span class="o">t</span>
  
    <span class="c">(** Creates a new query handler from a config *)</span>
    <span class="k">val</span> <span class="o">create</span> <span class="o">:</span> <span class="o">config</span> <span class="o">-&gt;</span> <span class="o">t</span>
  
    <span class="c">(** Evaluate a given query, where both input and output are</span>
<span class="c">        s-expressions *)</span>
    <span class="k">val</span> <span class="o">e</span><span class="n">val</span> <span class="o">:</span> <span class="o">t</span> <span class="o">-&gt;</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="nn">Or_error</span><span class="p">.</span><span class="n">t</span>
  <span class="k">end</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">module</span> <span class="k">type</span> <span class="nc">Query_handler</span> <span class="o">=</span>
  <span class="k">sig</span>
    <span class="k">type</span> <span class="o">config</span>
    <span class="k">val</span> <span class="o">config_of_se</span><span class="n">xp</span> <span class="o">:</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="o">config</span>
    <span class="k">val</span> <span class="o">se</span><span class="n">xp_of_config</span> <span class="o">:</span> <span class="o">config</span> <span class="o">-&gt;</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span>
    <span class="k">val</span> <span class="o">name</span> <span class="o">:</span> <span class="o">string</span>
    <span class="k">type</span> <span class="o">t</span>
    <span class="k">val</span> <span class="o">create</span> <span class="o">:</span> <span class="o">config</span> <span class="o">-&gt;</span> <span class="o">t</span>
    <span class="k">val</span> <span class="o">e</span><span class="n">val</span> <span class="o">:</span> <span class="o">t</span> <span class="o">-&gt;</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="nn">Or_error</span><span class="p">.</span><span class="n">t</span>
  <span class="k">end</span>
</pre></div>

      <p>
	Here, we used s-expressions as the format for queries and
	responses, as well as the configuration for the query
	handler. S-expressions are a simple, flexible, and
	human-readable serialization format commonly used in Core.  For
	now, it's enough to think of them as balanced parenthetical
	expressions whose atomic values are strings, e.g., <code>(this
	  (is an) (s expression))</code>.<a data-type="indexterm" data-primary="s-expressions" data-secondary="in queries and
	  responses">&nbsp;</a></p>

      <p>
	In addition, we use the <code>ppx_sexp_conv</code> syntax
	extension which interprets the <code>[@@deriving_sexp]</code>
	annotation. When <code>ppx_sexp_conv</code>
	sees <code>[@@deriving sexp]</code> attached to a signature,
	it replaces it with declarations of s-expression converters,
	for example:<a data-type="indexterm" data-primary="sexp declaration">&nbsp;</a></p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">module</span> <span class="k">type</span> <span class="nc">M</span> <span class="o">=</span> <span class="k">sig</span> <span class="k">type</span> <span class="o">t</span> <span class="o">[@@deri</span><span class="n">ving</span> <span class="o">se</span><span class="n">xp</span><span class="o">]</span> <span class="k">end</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">module</span> <span class="k">type</span> <span class="nc">M</span> <span class="o">=</span>
  <span class="k">sig</span> <span class="k">type</span> <span class="o">t</span> <span class="k">val</span> <span class="o">t_of_se</span><span class="n">xp</span> <span class="o">:</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="o">t</span> <span class="k">val</span> <span class="o">se</span><span class="n">xp_of_t</span> <span class="o">:</span> <span class="o">t</span> <span class="o">-&gt;</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="k">end</span>
</pre></div>

      <p>
	In a module, <code>[@@deriving sexp]</code> adds the
	implementation of those functions. Thus, we can write:</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">type</span> <span class="o">u</span> <span class="o">=</span> <span class="o">{</span> <span class="o">a:</span> <span class="o">int;</span> <span class="o">b:</span> <span class="o">float</span> <span class="o">}</span> <span class="o">[@@deri</span><span class="n">ving</span> <span class="o">se</span><span class="n">xp</span><span class="o">];;</span>
</pre><pre class="ge"><span></span><span class="k">type</span> <span class="o">u</span> <span class="o">=</span> <span class="o">{</span> <span class="o">a</span> <span class="o">:</span> <span class="o">int;</span> <span class="o">b</span> <span class="o">:</span> <span class="o">float;</span> <span class="o">}</span>
<span class="k">val</span> <span class="o">u_of_se</span><span class="n">xp</span> <span class="o">:</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="o">u</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
<span class="k">val</span> <span class="o">se</span><span class="n">xp_of_u</span> <span class="o">:</span> <span class="o">u</span> <span class="o">-&gt;</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre><pre><span></span><span class="o">#</span> <span class="o">se</span><span class="n">xp_of_u</span> <span class="o">{a=3;b=7.};;</span>
</pre><pre class="ge"><span></span><span class="o">-</span> <span class="o">:</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="o">((a</span> <span class="o">3)</span> <span class="o">(b</span> <span class="o">7))</span>
</pre><pre><span></span><span class="o">#</span> <span class="o">u_of_se</span><span class="n">xp</span> <span class="o">(</span><span class="nn">Sexp</span><span class="p">.</span><span class="n">of_string</span> <span class="s2">&quot;((a 43) (b 3.4))&quot;</span><span class="o">);;</span>
</pre><pre class="ge"><span></span><span class="o">-</span> <span class="o">:</span> <span class="o">u</span> <span class="o">=</span> <span class="o">{a</span> <span class="o">=</span> <span class="o">43;</span> <span class="o">b</span> <span class="o">=</span> <span class="o">3.4}</span>
</pre></div>

      <p>
	This is all described in more detail
	in <a href="17-data-serialization.html#data-serialization-with-s-expressions" data-type="xref">Chapter 17, Data Serialization With S
	Expressions</a>.</p>

      <section id="implementing-a-query-handler" data-type="sect2">
        <h2>Implementing a Query Handler</h2>

        <p>
	  Let's look at some examples of query handlers that
          satisfy the <code>Query_handler</code> interface. The first
          example is a handler that produces unique integer IDs. It
          works by keeping an internal counter which it bumps every
          time it produces a new value. The input to the query in
          this case is just the trivial s-expression <code>()</code>,
          otherwise known as <code>Sexp.unit</code>:

	  <a data-type="indexterm" data-primary="query-handlers" data-secondary="implementation of">&nbsp;</a></p>

        <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">module</span> <span class="nc">Unique</span> <span class="o">=</span> <span class="k">struct</span>
    <span class="k">type</span> <span class="o">config</span> <span class="o">=</span> <span class="o">int</span> <span class="o">[@@deri</span><span class="n">ving</span> <span class="o">se</span><span class="n">xp</span><span class="o">]</span>
    <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="o">{</span> <span class="k">mutable</span> <span class="o">ne</span><span class="n">xt_id</span><span class="o">:</span> <span class="o">int</span> <span class="o">}</span>
  
    <span class="k">let</span> <span class="o">name</span> <span class="o">=</span> <span class="s2">&quot;unique&quot;</span>
    <span class="k">let</span> <span class="o">create</span> <span class="o">start_at</span> <span class="o">=</span> <span class="o">{</span> <span class="o">ne</span><span class="n">xt_id</span> <span class="o">=</span> <span class="o">start_at</span> <span class="o">}</span>
  
    <span class="k">let</span> <span class="o">e</span><span class="n">val</span> <span class="o">t</span> <span class="o">se</span><span class="n">xp</span> <span class="o">=</span>
      <span class="k">match</span> <span class="nn">Or_error</span><span class="p">.</span><span class="n">try_with</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="o">unit_of_se</span><span class="n">xp</span> <span class="o">se</span><span class="n">xp</span><span class="o">)</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Error</span> <span class="o">_</span> <span class="k">as</span> <span class="o">err</span> <span class="o">-&gt;</span> <span class="o">err</span>
      <span class="o">|</span> <span class="nc">Ok</span> <span class="bp">()</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="o">response</span> <span class="o">=</span> <span class="nc">Ok</span> <span class="o">(</span><span class="nn">Int</span><span class="p">.</span><span class="n">sexp_of_t</span> <span class="o">t.ne</span><span class="n">xt_id</span><span class="o">)</span> <span class="k">in</span>
        <span class="o">t.ne</span><span class="n">xt_id</span> <span class="o">&lt;-</span> <span class="o">t.ne</span><span class="n">xt_id</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
        <span class="o">response</span>
  <span class="k">end</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">module</span> <span class="nc">Unique</span> <span class="o">:</span>
  <span class="k">sig</span>
    <span class="k">type</span> <span class="o">config</span> <span class="o">=</span> <span class="o">int</span>
    <span class="k">val</span> <span class="o">config_of_se</span><span class="n">xp</span> <span class="o">:</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="o">config</span>
    <span class="k">val</span> <span class="o">se</span><span class="n">xp_of_config</span> <span class="o">:</span> <span class="o">config</span> <span class="o">-&gt;</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span>
    <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="o">{</span> <span class="k">mutable</span> <span class="o">ne</span><span class="n">xt_id</span> <span class="o">:</span> <span class="o">config;</span> <span class="o">}</span>
    <span class="k">val</span> <span class="o">name</span> <span class="o">:</span> <span class="o">string</span>
    <span class="k">val</span> <span class="o">create</span> <span class="o">:</span> <span class="o">config</span> <span class="o">-&gt;</span> <span class="o">t</span>
    <span class="k">val</span> <span class="o">e</span><span class="n">val</span> <span class="o">:</span> <span class="o">t</span> <span class="o">-&gt;</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span><span class="o">,</span> <span class="nn">Error</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="o">result</span>
  <span class="k">end</span>
</pre></div>

        <p>
	  We can use this module to create an instance of the
          <code>Unique</code> query handler and interact with it
          directly:</p>

        <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">uni</span><span class="n">que</span> <span class="o">=</span> <span class="nn">Unique</span><span class="p">.</span><span class="n">create</span> <span class="o">0;;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">uni</span><span class="n">que</span> <span class="o">:</span> <span class="nn">Unique</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="o">{</span><span class="nn">Unique</span><span class="p">.</span><span class="n">next_id</span> <span class="o">=</span> <span class="o">0}</span>
</pre><pre><span></span><span class="o">#</span> <span class="nn">Unique</span><span class="p">.</span><span class="n">eval</span> <span class="o">uni</span><span class="n">que</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">unit</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="o">-</span> <span class="o">:</span> <span class="o">(</span><span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span><span class="o">,</span> <span class="nn">Error</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="o">result</span> <span class="o">=</span> <span class="nc">Ok</span> <span class="o">0</span>
</pre><pre><span></span><span class="o">#</span> <span class="nn">Unique</span><span class="p">.</span><span class="n">eval</span> <span class="o">uni</span><span class="n">que</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">unit</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="o">-</span> <span class="o">:</span> <span class="o">(</span><span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span><span class="o">,</span> <span class="nn">Error</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="o">result</span> <span class="o">=</span> <span class="nc">Ok</span> <span class="mi">1</span>
</pre></div>

        <p>Here's another example: a query handler that does
        directory listings. Here, the config is the default
        directory that relative paths are interpreted within:</p>

        <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">module</span> <span class="nc">List_dir</span> <span class="o">=</span> <span class="k">struct</span>
    <span class="k">type</span> <span class="o">config</span> <span class="o">=</span> <span class="o">string</span> <span class="o">[@@deri</span><span class="n">ving</span> <span class="o">se</span><span class="n">xp</span><span class="o">]</span>
    <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="o">{</span> <span class="o">c</span><span class="n">wd</span><span class="o">:</span> <span class="o">string</span> <span class="o">}</span>
  
    <span class="c">(** [is_abs p] Returns true if [p] is an absolute path  *)</span>
    <span class="k">let</span> <span class="o">is_abs</span> <span class="o">p</span> <span class="o">=</span>
      <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="o">p</span> <span class="o">&gt;</span> <span class="o">0</span> <span class="o">&amp;&amp;</span> <span class="o">p.[0]</span> <span class="o">=</span> <span class="sc">&#39;/&#39;</span>
  
    <span class="k">let</span> <span class="o">name</span> <span class="o">=</span> <span class="s2">&quot;ls&quot;</span>
    <span class="k">let</span> <span class="o">create</span> <span class="o">c</span><span class="n">wd</span> <span class="o">=</span> <span class="o">{</span> <span class="o">c</span><span class="n">wd</span> <span class="o">}</span>
  
    <span class="k">let</span> <span class="o">e</span><span class="n">val</span> <span class="o">t</span> <span class="o">se</span><span class="n">xp</span> <span class="o">=</span>
      <span class="k">match</span> <span class="nn">Or_error</span><span class="p">.</span><span class="n">try_with</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="o">string_of_se</span><span class="n">xp</span> <span class="o">se</span><span class="n">xp</span><span class="o">)</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Error</span> <span class="o">_</span> <span class="k">as</span> <span class="o">err</span> <span class="o">-&gt;</span> <span class="o">err</span>
      <span class="o">|</span> <span class="nc">Ok</span> <span class="o">dir</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="o">dir</span> <span class="o">=</span>
          <span class="k">if</span> <span class="o">is_abs</span> <span class="o">dir</span> <span class="k">then</span> <span class="o">dir</span>
          <span class="k">else</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="o">t.c</span><span class="n">wd</span> <span class="o">dir</span>
        <span class="k">in</span>
        <span class="nc">Ok</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">sexp_of_t</span> <span class="nn">String</span><span class="p">.</span><span class="n">sexp_of_t</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">readdir</span> <span class="o">dir))</span>
  <span class="k">end</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">module</span> <span class="nc">List_dir</span> <span class="o">:</span>
  <span class="k">sig</span>
    <span class="k">type</span> <span class="o">config</span> <span class="o">=</span> <span class="o">string</span>
    <span class="k">val</span> <span class="o">config_of_se</span><span class="n">xp</span> <span class="o">:</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="o">config</span>
    <span class="k">val</span> <span class="o">se</span><span class="n">xp_of_config</span> <span class="o">:</span> <span class="o">config</span> <span class="o">-&gt;</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span>
    <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="o">{</span> <span class="o">c</span><span class="n">wd</span> <span class="o">:</span> <span class="o">config;</span> <span class="o">}</span>
    <span class="k">val</span> <span class="o">is_abs</span> <span class="o">:</span> <span class="o">config</span> <span class="o">-&gt;</span> <span class="o">bool</span>
    <span class="k">val</span> <span class="o">name</span> <span class="o">:</span> <span class="o">config</span>
    <span class="k">val</span> <span class="o">create</span> <span class="o">:</span> <span class="o">config</span> <span class="o">-&gt;</span> <span class="o">t</span>
    <span class="k">val</span> <span class="o">e</span><span class="n">val</span> <span class="o">:</span> <span class="o">t</span> <span class="o">-&gt;</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span><span class="o">,</span> <span class="nn">Error</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="o">result</span>
  <span class="k">end</span>
</pre></div>

        <p>Again, we can create an instance of this query handler
        and interact with it directly:</p>

        <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">list_dir</span> <span class="o">=</span> <span class="nn">List_dir</span><span class="p">.</span><span class="n">create</span> <span class="s2">&quot;/var&quot;</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">list_dir</span> <span class="o">:</span> <span class="nn">List_dir</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="o">{</span><span class="nn">List_dir</span><span class="p">.</span><span class="n">cwd</span> <span class="o">=</span> <span class="s2">&quot;/var&quot;</span><span class="o">}</span>
</pre><pre><span></span><span class="o">#</span> <span class="nn">List_dir</span><span class="p">.</span><span class="n">eval</span> <span class="o">list_dir</span> <span class="o">(se</span><span class="n">xp_of_string</span> <span class="s2">&quot;.&quot;</span><span class="o">);;</span>
</pre><pre class="ge"><span></span><span class="o">-</span> <span class="o">:</span> <span class="o">(</span><span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span><span class="o">,</span> <span class="nn">Error</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="o">result</span> <span class="o">=</span>
<span class="nc">Ok</span> <span class="o">(backups</span> <span class="o">cache</span> <span class="o">lib</span> <span class="o">local</span> <span class="o">lock</span> <span class="o">log</span> <span class="o">mail</span> <span class="o">opt</span> <span class="o">run</span> <span class="o">spool</span> <span class="o">tmp</span> <span class="o">crash)</span>
</pre><pre><span></span><span class="o">#</span> <span class="nn">List_dir</span><span class="p">.</span><span class="n">eval</span> <span class="o">list_dir</span> <span class="o">(se</span><span class="n">xp_of_string</span> <span class="s2">&quot;yp&quot;</span><span class="o">);;</span>
</pre><pre class="ge">Exception: Sys_error "/var/yp: No such file or directory".</pre></div>
      </section>

      <section id="dispatching-to-multiple-query-handlers" data-type="sect2">
        <h2>Dispatching to Multiple Query Handlers</h2>

        <p>Now, what if we want to dispatch queries to any of an
        arbitrary collection of handlers? Ideally, we'd just like
        to pass in the handlers as a simple data structure like a
        list. This is awkward to do with modules and functors
        alone, but it's quite natural with first-class modules. The
        first thing we'll need to do is create a signature that
        combines a <code>Query_handler</code> module with an
        instantiated query handler:<a data-type="indexterm" data-primary="query-handlers" data-secondary="dispatching to multiple">&nbsp;</a></p>

        <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">module</span> <span class="k">type</span> <span class="nc">Query_handler_instance</span> <span class="o">=</span> <span class="k">sig</span>
    <span class="k">module</span> <span class="nc">Query_handler</span> <span class="o">:</span> <span class="nc">Query_handler</span>
    <span class="k">val</span> <span class="o">this</span> <span class="o">:</span> <span class="nn">Query_handler</span><span class="p">.</span><span class="n">t</span>
  <span class="k">end</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">module</span> <span class="k">type</span> <span class="nc">Query_handler_instance</span> <span class="o">=</span>
  <span class="k">sig</span> <span class="k">module</span> <span class="nc">Query_handler</span> <span class="o">:</span> <span class="nc">Query_handler</span> <span class="k">val</span> <span class="o">this</span> <span class="o">:</span> <span class="nn">Query_handler</span><span class="p">.</span><span class="n">t</span> <span class="k">end</span>
</pre></div>

        <p>With this signature, we can create a first-class module
        that encompasses both an instance of the query and the
        matching operations for working with that query.</p>

        <p>We can create an instance as follows:</p>

        <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">uni</span><span class="n">que_instance</span> <span class="o">=</span>
    <span class="o">(</span><span class="k">module</span> <span class="k">struct</span>
      <span class="k">module</span> <span class="nc">Query_handler</span> <span class="o">=</span> <span class="nc">Unique</span>
      <span class="k">let</span> <span class="o">this</span> <span class="o">=</span> <span class="nn">Unique</span><span class="p">.</span><span class="n">create</span> <span class="o">0</span>
    <span class="k">end</span> <span class="o">:</span> <span class="nc">Query_handler_instance</span><span class="o">);;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">uni</span><span class="n">que_instance</span> <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Query_handler_instance</span><span class="o">)</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">module</span><span class="o">&gt;</span>
</pre></div>

        <p>Constructing instances in this way is a little verbose,
        but we can write a function that eliminates most of this
        boilerplate. Note that we are again making use of a locally
        abstract type:</p>

        <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">build_instance</span>
        <span class="o">(</span><span class="k">type</span> <span class="o">a)</span>
        <span class="o">(</span><span class="k">module</span> <span class="nc">Q</span> <span class="o">:</span> <span class="nc">Query_handler</span> <span class="k">with</span> <span class="k">type</span> <span class="o">config</span> <span class="o">=</span> <span class="o">a)</span>
        <span class="o">config</span>
    <span class="o">=</span>
    <span class="o">(</span><span class="k">module</span> <span class="k">struct</span>
      <span class="k">module</span> <span class="nc">Query_handler</span> <span class="o">=</span> <span class="nc">Q</span>
      <span class="k">let</span> <span class="o">this</span> <span class="o">=</span> <span class="nn">Q</span><span class="p">.</span><span class="n">create</span> <span class="o">config</span>
    <span class="k">end</span> <span class="o">:</span> <span class="nc">Query_handler_instance</span><span class="o">)</span>
  <span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">build_instance</span> <span class="o">:</span>
  <span class="o">(</span><span class="k">module</span> <span class="nc">Query_handler</span> <span class="k">with</span> <span class="k">type</span> <span class="o">config</span> <span class="o">=</span> <span class="k">&#39;</span><span class="o">a)</span> <span class="o">-&gt;</span>
  <span class="k">&#39;</span><span class="o">a</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Query_handler_instance</span><span class="o">)</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div>

        <p>Using <code>build_instance</code>, constructing a new
        instance becomes a one-liner:</p>

        <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">uni</span><span class="n">que_instance</span> <span class="o">=</span> <span class="o">build_instance</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Unique</span><span class="o">)</span> <span class="o">0;;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">uni</span><span class="n">que_instance</span> <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Query_handler_instance</span><span class="o">)</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">module</span><span class="o">&gt;</span>
</pre><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">list_dir_instance</span> <span class="o">=</span> <span class="o">build_instance</span> <span class="o">(</span><span class="k">module</span> <span class="nc">List_dir</span><span class="o">)</span>  <span class="s2">&quot;/var&quot;</span><span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">list_dir_instance</span> <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Query_handler_instance</span><span class="o">)</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">module</span><span class="o">&gt;</span>
</pre></div>

        <p>We can now write code that lets you dispatch queries to
        one of a list of query handler instances. We assume that
        the shape of the query is as follows:</p>

        <div class="highlight"><pre>(query-name query)
</pre></div>

        <p>where <em><code>query-name</code></em> is the name used
        to determine which query handler to dispatch the query to,
        and <em><code>query</code></em> is the body of the
        query.</p>

        <p>The first thing we'll need is a function that takes a
        list of query handler instances and constructs a dispatch
        table from it:</p>

        <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">build_dispatch_table</span> <span class="o">handlers</span> <span class="o">=</span>
    <span class="k">let</span> <span class="o">table</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="nn">Table</span><span class="p">.</span><span class="n">create</span> <span class="bp">()</span> <span class="k">in</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">handlers</span>
      <span class="o">~f:(</span><span class="k">fun</span> <span class="o">((</span><span class="k">module</span> <span class="nc">I</span> <span class="o">:</span> <span class="nc">Query_handler_instance</span><span class="o">)</span> <span class="k">as</span> <span class="o">instance)</span> <span class="o">-&gt;</span>
        <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">set</span> <span class="o">table</span> <span class="o">~key:</span><span class="nn">I</span><span class="p">.</span><span class="nn">Query_handler</span><span class="p">.</span><span class="n">name</span> <span class="o">~data:instance);</span>
    <span class="o">table</span>
  <span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">build_dispatch_table</span> <span class="o">:</span>
  <span class="o">(</span><span class="k">module</span> <span class="nc">Query_handler_instance</span><span class="o">)</span> <span class="o">list</span> <span class="o">-&gt;</span>
  <span class="o">(</span><span class="k">module</span> <span class="nc">Query_handler_instance</span><span class="o">)</span> <span class="nn">String</span><span class="p">.</span><span class="nn">Table</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div>

        <p>Now, we need a function that dispatches to a handler
        using a dispatch table:</p>

        <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">dispatch</span> <span class="o">dispatch_table</span> <span class="o">name_and_</span><span class="n">query</span> <span class="o">=</span>
    <span class="k">match</span> <span class="o">name_and_</span><span class="n">query</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nn">Sexp</span><span class="p">.</span><span class="nc">List</span> <span class="o">[</span><span class="nn">Sexp</span><span class="p">.</span><span class="nc">Atom</span> <span class="o">name;</span> <span class="n">query</span><span class="o">]</span> <span class="o">-&gt;</span>
      <span class="k">begin</span> <span class="k">match</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="o">dispatch_table</span> <span class="o">name</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
        <span class="nn">Or_error</span><span class="p">.</span><span class="n">error</span> <span class="s2">&quot;Could not find matching handler&quot;</span>
          <span class="o">name</span> <span class="nn">String</span><span class="p">.</span><span class="n">sexp_of_t</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="o">(</span><span class="k">module</span> <span class="nc">I</span> <span class="o">:</span> <span class="nc">Query_handler_instance</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="nn">I</span><span class="p">.</span><span class="nn">Query_handler</span><span class="p">.</span><span class="n">eval</span> <span class="nn">I</span><span class="p">.</span><span class="n">this</span> <span class="n">query</span>
      <span class="k">end</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
      <span class="nn">Or_error</span><span class="p">.</span><span class="n">error_string</span> <span class="s2">&quot;malformed query&quot;</span>
  <span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">dispatch</span> <span class="o">:</span>
  <span class="o">(string,</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Query_handler_instance</span><span class="o">))</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span>
  <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="nn">Or_error</span><span class="p">.</span><span class="n">t</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div>

        <p>This function interacts with an instance by unpacking it
        into a module <code>I</code> and then using the query
        handler instance (<code>I.this</code>) in concert with the
        associated module
        (<code>I.Query_handler</code>).<a data-type="indexterm" data-primary="I.Query_handler module">&nbsp;</a></p>

        <p>The bundling together of the module and the value is in
        many ways reminiscent of object-oriented languages. One key
        difference, is that first-class modules allow you to
        package up more than just functions or methods. As we've
        seen, you can also include types and even modules. We've
        only used it in a small way here, but this extra power
        allows you to build more sophisticated components that
        involve multiple interdependent types and values.</p>

        <p>Now let's turn this into a complete, running example by
        adding a command-line interface:</p>

        <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="k">rec</span> <span class="o">cli</span> <span class="o">dispatch_table</span> <span class="o">=</span>
    <span class="o">printf</span> <span class="s2">&quot;&gt;&gt;&gt; %!&quot;</span><span class="o">;</span>
    <span class="k">let</span> <span class="o">result</span> <span class="o">=</span>
      <span class="k">match</span> <span class="nn">In_channel</span><span class="p">.</span><span class="n">input_line</span> <span class="o">stdin</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="o">`</span><span class="nc">Stop</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="o">line</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="nn">Or_error</span><span class="p">.</span><span class="n">try_with</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">of_string</span> <span class="o">line)</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Error</span> <span class="o">e</span> <span class="o">-&gt;</span> <span class="o">`</span><span class="nc">Continue</span> <span class="o">(</span><span class="nn">Error</span><span class="p">.</span><span class="n">to_string_hum</span> <span class="o">e)</span>
        <span class="o">|</span> <span class="nc">Ok</span> <span class="o">(</span><span class="nn">Sexp</span><span class="p">.</span><span class="nc">Atom</span> <span class="s2">&quot;quit&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">`</span><span class="nc">Stop</span>
        <span class="o">|</span> <span class="nc">Ok</span> <span class="n">query</span> <span class="o">-&gt;</span>
          <span class="k">begin</span> <span class="k">match</span> <span class="o">dispatch</span> <span class="o">dispatch_table</span> <span class="n">query</span> <span class="k">with</span>
          <span class="o">|</span> <span class="nc">Error</span> <span class="o">e</span> <span class="o">-&gt;</span> <span class="o">`</span><span class="nc">Continue</span> <span class="o">(</span><span class="nn">Error</span><span class="p">.</span><span class="n">to_string_hum</span> <span class="o">e)</span>
          <span class="o">|</span> <span class="nc">Ok</span> <span class="o">s</span>    <span class="o">-&gt;</span> <span class="o">`</span><span class="nc">Continue</span> <span class="o">(</span><span class="nn">Sexp</span><span class="p">.</span><span class="n">to_string_hum</span> <span class="o">s)</span>
          <span class="k">end</span><span class="o">;</span>
    <span class="k">in</span>
    <span class="k">match</span> <span class="o">result</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Stop</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Continue</span> <span class="o">msg</span> <span class="o">-&gt;</span>
      <span class="o">printf</span> <span class="s2">&quot;%s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="o">msg;</span>
      <span class="o">cli</span> <span class="o">dispatch_table</span>
  <span class="o">;;</span>
</pre><pre class="ge">Characters 95-100:
Warning 3: deprecated: Core_kernel.stdin
[since 2016-04] Use [In_channel.stdin]</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">cli</span> <span class="o">:</span> <span class="o">(string,</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Query_handler_instance</span><span class="o">))</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="o">unit</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div>

        <p>We can most effectively run this command-line interface
        from a standalone program, which we can do by putting the
        above code in a file along with following command to launch
        the interface:</p>

      <div class="highlight"><pre><span></span><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="o">cli</span> <span class="o">(build_dispatch_table</span> <span class="o">[uni</span><span class="n">que_instance</span><span class="o">;</span> <span class="o">list_dir_instance])</span>
</pre></div>

        <p>Here's an example of a session with this program:</p>

        <div class="highlight"><pre>$ ./query_handler.byte 
&gt;&gt;&gt; (unique ())
0
&gt;&gt;&gt; (unique ())
1
&gt;&gt;&gt; (ls .)
(agentx at audit backups db empty folders jabberd lib log mail msgs named
 netboot pgsql_socket_alt root rpc run rwho spool tmp vm yp)
&gt;&gt;&gt; (ls vm)
(sleepimage swapfile0 swapfile1 swapfile2 swapfile3 swapfile4 swapfile5
 swapfile6)
</pre></div>
      </section>

      <section id="loading-and-unloading-query-handlers" data-type="sect2">
        <h2>Loading and Unloading Query Handlers</h2>

        <p>One of the advantages of first-class modules is that
        they afford a great deal of dynamism and flexibility. For
        example, it's a fairly simple matter to change our design
        to allow query handlers to be loaded and unloaded at
        runtime.<a data-type="indexterm" data-primary="query-handlers" data-secondary="loading/unloading of">&nbsp;</a></p>

        <p>We'll do this by creating a query handler whose job is
        to control the set of active query handlers. The module in
        question will be called <code>Loader</code>, and its
        configuration is a list of known <code>Query_handler</code>
        modules. Here are the basic types:</p>

        <div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">Loader</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="o">config</span> <span class="o">=</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Query_handler</span><span class="o">)</span> <span class="o">list</span> <span class="o">se</span><span class="n">xp_opaque</span>
  <span class="o">[@@deri</span><span class="n">ving</span> <span class="o">se</span><span class="n">xp</span><span class="o">]</span>

  <span class="k">type</span> <span class="o">t</span> <span class="o">=</span> <span class="o">{</span> <span class="o">kno</span><span class="n">wn</span>  <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Query_handler</span><span class="o">)</span>          <span class="nn">String</span><span class="p">.</span><span class="nn">Table</span><span class="p">.</span><span class="n">t</span>
           <span class="o">;</span> <span class="o">acti</span><span class="n">ve</span> <span class="o">:</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Query_handler_instance</span><span class="o">)</span> <span class="nn">String</span><span class="p">.</span><span class="nn">Table</span><span class="p">.</span><span class="n">t</span>
           <span class="o">}</span>

  <span class="k">let</span> <span class="o">name</span> <span class="o">=</span> <span class="s2">&quot;loader&quot;</span>
</pre></div>

        <p>Note that a <code>Loader.t</code> has two tables: one
        containing the known query handler modules, and one
        containing the active query handler instances. The
        <code>Loader.t</code> will be responsible for creating new
        instances and adding them to the table, as well as for
        removing instances, all in response to user queries.</p>

        <p>Next, we'll need a function for creating a
        <code>Loader.t</code>. This function requires the list of
        known query handler modules. Note that the table of active
        modules starts out as empty:</p>

        <div class="highlight"><pre><span></span><span class="k">let</span> <span class="o">create</span> <span class="o">kno</span><span class="n">wn_list</span> <span class="o">=</span>
    <span class="k">let</span> <span class="o">acti</span><span class="n">ve</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="nn">Table</span><span class="p">.</span><span class="n">create</span> <span class="bp">()</span> <span class="k">in</span>
    <span class="k">let</span> <span class="o">kno</span><span class="n">wn</span>  <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="nn">Table</span><span class="p">.</span><span class="n">create</span> <span class="bp">()</span> <span class="k">in</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">kno</span><span class="n">wn_list</span>
      <span class="o">~f:(</span><span class="k">fun</span> <span class="o">((</span><span class="k">module</span> <span class="nc">Q</span> <span class="o">:</span> <span class="nc">Query_handler</span><span class="o">)</span> <span class="k">as</span> <span class="n">q</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">set</span> <span class="o">kno</span><span class="n">wn</span> <span class="o">~key:</span><span class="nn">Q</span><span class="p">.</span><span class="n">name</span> <span class="o">~data:</span><span class="n">q</span><span class="o">);</span>
    <span class="o">{</span> <span class="o">kno</span><span class="n">wn</span><span class="o">;</span> <span class="o">acti</span><span class="n">ve</span> <span class="o">}</span>
</pre></div>

        <p>Now we'll start writing out the functions for
        manipulating the table of active query handlers. We'll
        start with the function for loading an instance. Note that
        it takes as an argument both the name of the query handler
        and the configuration for instantiating that handler in the
        form of an s-expression. These are used for creating a
        first-class module of type <code>(module
        Query_handler_instance)</code>, which is then added to the
        active table:</p>

        <div class="highlight"><pre><span></span><span class="k">let</span> <span class="o">load</span> <span class="o">t</span> <span class="o">handler_name</span> <span class="o">config</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="o">t.acti</span><span class="n">ve</span> <span class="o">handler_name</span> <span class="k">then</span>
      <span class="nn">Or_error</span><span class="p">.</span><span class="n">error</span> <span class="s2">&quot;Can&#39;t re-register an active handler&quot;</span>
        <span class="o">handler_name</span> <span class="nn">String</span><span class="p">.</span><span class="n">sexp_of_t</span>
    <span class="k">else</span>
      <span class="k">match</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="o">t.kno</span><span class="n">wn</span> <span class="o">handler_name</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
        <span class="nn">Or_error</span><span class="p">.</span><span class="n">error</span> <span class="s2">&quot;Unknown handler&quot;</span> <span class="o">handler_name</span> <span class="nn">String</span><span class="p">.</span><span class="n">sexp_of_t</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="o">(</span><span class="k">module</span> <span class="nc">Q</span> <span class="o">:</span> <span class="nc">Query_handler</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="o">instance</span> <span class="o">=</span>
          <span class="o">(</span><span class="k">module</span> <span class="k">struct</span>
             <span class="k">module</span> <span class="nc">Query_handler</span> <span class="o">=</span> <span class="nc">Q</span>
             <span class="k">let</span> <span class="o">this</span> <span class="o">=</span> <span class="nn">Q</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="nn">Q</span><span class="p">.</span><span class="n">config_of_sexp</span> <span class="o">config)</span>
           <span class="k">end</span> <span class="o">:</span> <span class="nc">Query_handler_instance</span><span class="o">)</span>
        <span class="k">in</span>
        <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">set</span> <span class="o">t.acti</span><span class="n">ve</span> <span class="o">~key:handler_name</span> <span class="o">~data:instance;</span>
        <span class="nc">Ok</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">unit</span>
</pre></div>

        <p>Since the <code>load</code> function will refuse to
        <code>load</code> an already active handler, we also need
        the ability to unload a handler. Note that the handler
        explicitly refuses to unload itself:</p>

        <div class="highlight"><pre><span></span><span class="k">let</span> <span class="o">unload</span> <span class="o">t</span> <span class="o">handler_name</span> <span class="o">=</span>
    <span class="k">if</span> <span class="o">not</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="o">t.acti</span><span class="n">ve</span> <span class="o">handler_name)</span> <span class="k">then</span>
      <span class="nn">Or_error</span><span class="p">.</span><span class="n">error</span> <span class="s2">&quot;Handler not active&quot;</span> <span class="o">handler_name</span> <span class="nn">String</span><span class="p">.</span><span class="n">sexp_of_t</span>
    <span class="k">else</span> <span class="k">if</span> <span class="o">handler_name</span> <span class="o">=</span> <span class="o">name</span> <span class="k">then</span>
      <span class="nn">Or_error</span><span class="p">.</span><span class="n">error_string</span> <span class="s2">&quot;It&#39;s unwise to unload yourself&quot;</span>
    <span class="k">else</span> <span class="o">(</span>
      <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="o">t.acti</span><span class="n">ve</span> <span class="o">handler_name;</span>
      <span class="nc">Ok</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">unit</span>
    <span class="o">)</span>
</pre></div>

        <p>Finally, we need to implement the <code>eval</code>
        function, which will determine the query <span class="keep-together">interface</span> presented to the user.
        We'll do this by creating a variant type, and using the
        s-expression converter generated for that type to parse the
        query from the user:</p>

        <div class="highlight"><pre><span></span><span class="k">type</span> <span class="o">re</span><span class="n">quest</span> <span class="o">=</span>
    <span class="o">|</span> <span class="nc">Load</span> <span class="k">of</span> <span class="o">string</span> <span class="o">*</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span>
    <span class="o">|</span> <span class="nc">Unload</span> <span class="k">of</span> <span class="o">string</span>
    <span class="o">|</span> <span class="nc">Known_services</span>
    <span class="o">|</span> <span class="nc">Active_services</span>
  <span class="o">[@@deri</span><span class="n">ving</span> <span class="o">se</span><span class="n">xp</span><span class="o">]</span>
</pre></div>

        <p>The <code>eval</code> function itself is fairly
        straightforward, dispatching to the appropriate functions
        to respond to each type of query. Note that we write
        <code>&lt;:sexp_of&lt;string list&gt;&gt;</code> to
        autogenerate a function for converting a list of strings to
        an s-expression, as described in <a href="17-data-serialization.html#data-serialization-with-s-expressions" data-type="xref">Chapter 17, Data Serialization With S
        Expressions</a>.</p>

        <p>This function ends the definition of the
        <code>Loader</code> module:</p>

        <div class="highlight"><pre><span></span><span class="k">let</span> <span class="o">e</span><span class="n">val</span> <span class="o">t</span> <span class="o">se</span><span class="n">xp</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Or_error</span><span class="p">.</span><span class="n">try_with</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="o">re</span><span class="n">quest_of_sexp</span> <span class="o">se</span><span class="n">xp</span><span class="o">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Error</span> <span class="o">_</span> <span class="k">as</span> <span class="o">err</span> <span class="o">-&gt;</span> <span class="o">err</span>
    <span class="o">|</span> <span class="nc">Ok</span> <span class="o">resp</span> <span class="o">-&gt;</span>
      <span class="k">match</span> <span class="o">resp</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Load</span> <span class="o">(name,config)</span> <span class="o">-&gt;</span> <span class="o">load</span>   <span class="o">t</span> <span class="o">name</span> <span class="o">config</span>
      <span class="o">|</span> <span class="nc">Unload</span> <span class="o">name</span>        <span class="o">-&gt;</span> <span class="o">unload</span> <span class="o">t</span> <span class="o">name</span>
      <span class="o">|</span> <span class="nc">Known_services</span> <span class="o">-&gt;</span>
        <span class="nc">Ok</span> <span class="o">([%se</span><span class="n">xp_of</span><span class="o">:</span> <span class="o">string</span> <span class="o">list]</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">keys</span> <span class="o">t.kno</span><span class="n">wn</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">Active_services</span> <span class="o">-&gt;</span>
        <span class="nc">Ok</span> <span class="o">([%se</span><span class="n">xp_of</span><span class="o">:</span> <span class="o">string</span> <span class="o">list]</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">keys</span> <span class="o">t.acti</span><span class="n">ve</span><span class="o">))</span>
<span class="k">end</span>
</pre></div>

        <p>Finally, we can put this all together with the
        command-line interface. We first create an instance of the
        loader query handler and then add that instance to the
        loader's active table. We can then just launch the
        command-line interface, passing it the active table:</p>

        <div class="highlight"><pre><span></span><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="o">loader</span> <span class="o">=</span> <span class="nn">Loader</span><span class="p">.</span><span class="n">create</span> <span class="o">[(</span><span class="k">module</span> <span class="nc">Unique</span><span class="o">);</span> <span class="o">(</span><span class="k">module</span> <span class="nc">List_dir</span><span class="o">)]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="o">loader_instance</span> <span class="o">=</span>
    <span class="o">(</span><span class="k">module</span> <span class="k">struct</span>
       <span class="k">module</span> <span class="nc">Query_handler</span> <span class="o">=</span> <span class="nc">Loader</span>
       <span class="k">let</span> <span class="o">this</span> <span class="o">=</span> <span class="o">loader</span>
     <span class="k">end</span> <span class="o">:</span> <span class="nc">Query_handler_instance</span><span class="o">)</span>
  <span class="k">in</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">set</span> <span class="o">loader.</span><span class="nn">Loader</span><span class="p">.</span><span class="n">active</span>
    <span class="o">~key:</span><span class="nn">Loader</span><span class="p">.</span><span class="n">name</span> <span class="o">~data:loader_instance;</span>
  <span class="o">cli</span> <span class="o">loader.</span><span class="nn">Loader</span><span class="p">.</span><span class="n">active</span>
</pre></div>

        <p>Now build this into a command-line interface to
        experiment with it:</p>
        <div class="highlight"><pre>(jbuild_version 1)

(executable
  ((name query_handler_loader)
  (libraries (core core_kernel ppx_sexp_conv))
  (preprocess (pps (ppx_sexp_conv)))
))
</pre></div>
        <div class="highlight"><pre>$ jbuilder build query_handler_loader.exe
    ocamlopt .ppx/ppx_sexp_conv/ppx.exe
         ppx query_handler_loader.pp.ml
         ppx query_handler.pp.ml
         ppx query_handler_core.pp.ml
    ocamldep query_handler_loader.depends.ocamldep-output
      ocamlc query_handler_core.{cmi,cmo,cmt}
      ocamlc query_handler_loader.{cmi,cmo,cmt}
    ocamlopt query_handler_core.{cmx,o}
    ocamlopt query_handler_loader.{cmx,o}
    ocamlopt query_handler_loader.exe
</pre></div>

        <p>The resulting command-line interface behaves much as
        you'd expect, starting out with no query handlers available
        but giving you the ability to load and unload them. Here's
        an example of it in action. As you can see, we start out
        with <code>loader</code> itself as the only active
        handler:</p>

        <div class="highlight"><pre>$ ./query_handler_loader.byte
&gt;&gt;&gt; (loader known_services)
(ls unique)
&gt;&gt;&gt; (loader active_services)
(loader)
</pre></div>

        <p>Any attempt to use an inactive query handler will
        fail:</p>

        <div class="highlight"><pre>&gt;&gt;&gt; (ls .)
Could not find matching handler: ls
</pre></div>

        <p>But, we can load the <code>ls</code> handler with a
        config of our choice, at which point it will be available
        for use. And once we unload it, it will be unavailable yet
        again and could be reloaded with a different config:</p>

        <div class="highlight"><pre>&gt;&gt;&gt; (loader (load ls /var))
()
&gt;&gt;&gt; (ls /var)
(agentx at audit backups db empty folders jabberd lib log mail msgs named
 netboot pgsql_socket_alt root rpc run rwho spool tmp vm yp)
&gt;&gt;&gt; (loader (unload ls))
()
&gt;&gt;&gt; (ls /var)
Could not find matching handler: ls
</pre></div>

        <p>Notably, the loader can't be loaded (since it's not on
        the list of known handlers) and can't be unloaded
        either:</p>

        <div class="highlight"><pre>&gt;&gt;&gt; (loader (unload loader))
It's unwise to unload yourself
</pre></div>

        <p>Although we won't describe the details here, we can push
        this dynamism yet further using OCaml's dynamic linking
        facilities, which allow you to compile and link in new code to
        a running program. This can be automated using libraries
        like <code>ocaml_plugin</code>, which can be installed via
        OPAM, and which takes care of much of the workflow around
        setting up dynamic linking.

	  <a data-type="indexterm" data-startref="FCMquery">&nbsp;</a></p>
      </section>
    </section>

    <section id="living-without-first-class-modules" data-type="sect1">
      <h1>Living Without First-Class Modules</h1>

      <p>It's worth noting that most designs that can be done with
      first-class modules can be simulated without them, with some
      level of awkwardness. For example, we could rewrite our query
      handler example without first-class modules using the
      following types:<a data-type="indexterm" data-primary="first-class modules" data-secondary="alternatives to">&nbsp;</a></p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">type</span> <span class="n">query_handler_instance</span> <span class="o">=</span> <span class="o">{</span> <span class="o">name</span> <span class="o">:</span> <span class="o">string</span>
                                <span class="o">;</span> <span class="o">e</span><span class="n">val</span> <span class="o">:</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="nn">Or_error</span><span class="p">.</span><span class="n">t</span>
                                <span class="o">};;</span>
</pre><pre class="ge"><span></span><span class="k">type</span> <span class="n">query_handler_instance</span> <span class="o">=</span> <span class="o">{</span>
  <span class="o">name</span> <span class="o">:</span> <span class="o">string;</span>
  <span class="o">e</span><span class="n">val</span> <span class="o">:</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="nn">Or_error</span><span class="p">.</span><span class="n">t</span><span class="o">;</span>
<span class="o">}</span>
</pre><pre><span></span><span class="o">#</span> <span class="k">type</span> <span class="n">query_handler</span> <span class="o">=</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">query_handler_instance</span>
  <span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">type</span> <span class="n">query_handler</span> <span class="o">=</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">query_handler_instance</span>
</pre></div>

      <p>The idea here is that we hide the true types of the
      objects in question behind the functions stored in the
      closure. Thus, we could put the <code>Unique</code> query
      handler into this framework as follows:</p>

      <div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="o">uni</span><span class="n">que_handler</span> <span class="o">config_se</span><span class="n">xp</span> <span class="o">=</span>
    <span class="k">let</span> <span class="o">config</span> <span class="o">=</span> <span class="nn">Unique</span><span class="p">.</span><span class="n">config_of_sexp</span> <span class="o">config_se</span><span class="n">xp</span> <span class="k">in</span>
    <span class="k">let</span> <span class="o">uni</span><span class="n">que</span> <span class="o">=</span> <span class="nn">Unique</span><span class="p">.</span><span class="n">create</span> <span class="o">config</span> <span class="k">in</span>
    <span class="o">{</span> <span class="o">name</span> <span class="o">=</span> <span class="nn">Unique</span><span class="p">.</span><span class="n">name</span>
    <span class="o">;</span> <span class="o">e</span><span class="n">val</span> <span class="o">=</span> <span class="o">(</span><span class="k">fun</span> <span class="o">config</span> <span class="o">-&gt;</span> <span class="nn">Unique</span><span class="p">.</span><span class="n">eval</span> <span class="o">uni</span><span class="n">que</span> <span class="o">config)</span>
    <span class="o">}</span>
  <span class="o">;;</span>
</pre><pre class="ge"><span></span><span class="k">val</span> <span class="o">uni</span><span class="n">que_handler</span> <span class="o">:</span> <span class="nn">Sexp</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">query_handler_instance</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>
</pre></div>

      <p>For an example on this scale, the preceding approach is
      completely reasonable, and first-class modules are not really
      necessary. But the more functionality you need to hide away
      behind a set of closures, and the more complicated the
      relationships between the different types in question, the
      more awkward this approach becomes, and the better it is to
      use first-class modules.

	<a data-type="indexterm" data-startref="MODfirst">&nbsp;</a></p>
    </section>
  </section>
</article></div><a class="next-chapter" href="11-objects.html"><div class="content"><h1><small>Next: Chapter 11</small>Objects</h1></div></a><footer><div class="content"><ul><li><a href="http://twitter.com/realworldocaml">@realworldocaml</a></li><li><a href="http://twitter.com/yminsky">@yminsky</a></li><li><a href="http://twitter.com/avsm">@avsm</a></li><li><a href="https://plus.google.com/111219778721183890368">+hickey</a></li><li><a href="https://github.com/realworldocaml">GitHub</a></li><li><a href="http://www.goodreads.com/book/show/16087552-real-world-ocaml">goodreads</a></li></ul><p>Copyright 2012-2014 Jason Hickey, Anil Madhavapeddy and Yaron Minsky.</p></div></footer><script src="js/jquery.min.js"></script><script src="js/min/app-min.js"></script><script src="js/discourse.js"></script></body></html>